<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- <link rel="stylesheet" href="./css/pages/main.css"> -->
    <!-- <link rel="stylesheet" href="./css/pages/main.css"> -->
    <link rel="stylesheet" href="./css/pages/main.css">
    <title>Document</title>
</head>

<body>

    <div class="header">
        <div class="header-top">
            <div class="img-menu">
                <img src="./assets/img/toggle.png" alt="">
            </div>
            <div class="icon-misa">
                <img src="./assets/img/cukcuk-logo.png" alt="">
            </div>
            <div class="server">
                <h4>Chi nhánh Hà Nội</h4>
                <img src="./assets/icon/btn-next-page.svg">
            </div>
            <div class="user">
                <div class="avt"><img src="./assets/icon/avatar-default.png" alt=""></div>
                <div class="name">Vũ Cao Dũng</div>
                <div class="dot"><img src="./assets/icon/option.png" alt=""></div>
            </div>
        </div>

        <div class="home">
            <div class="sidebar">
                <ul>
                    <li>
                        <a href="#"><img src="./assets/icon/dashboard.png" alt=""><span>Trang chủ</span></a>
                    </li>
                    <li>
                        <a href="#"><img src="./assets/icon/report.png" alt=""><span>Báo cáo</span></a>
                    </li>
                    <li>
                        <a href="#"><img src="./assets/icon/dic-employee.png" alt=""><span>Nhân viên</span></a>
                    </li>
                    <li>
                        <a href="#"><img src="./assets/icon/setting.png" alt=""><span>Cài đặt</span></a>
                    </li>
                </ul>
                <div class="close">
                    <img src="./assets/icon/btn-prev-page.svg" alt="">
                    <div class="close-text">Thu gọn</div>
                </div>
            </div>

            <div class="main">
                <div class="header-main">
                    <h2 class="text-manager">Quản lý nhân viên</h2>
                    <button class="button-add-employee">
                        <img src="./assets/icon/add.png" alt="">
                        <h5>Thêm mới</h5>
                    </button>
                </div>

                <div class="table">
                    <div class="search">
                        <input type="text" id="myInput" placeholder="Tìm kiếm theo mã, họ tên">
                        <div class="export">
                            <img src="./assets/icon/export-excel-50.png" alt="">
                        </div>
                        <div class="reload">
                            <img src="./assets/icon/refresh.png" alt="">
                        </div>
                    </div>

                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>STT</th>
                                    <th>Mã nhân viên</th>
                                    <th>Họ và tên</th>
                                    <th>Giới tính</th>
                                    <th>Ngày sinh</th>
                                    <th>Địa chỉ Email</th>
                                    <th>Địa chỉ</th>
                                </tr>
                            </thead>
                            <tbody id="myTable">
                                <!-- data -->
                            </tbody>
                        </table>
                    </div>

                    <div class="end-table">
                        <div class="sum-record">Tổng: <span id="userCount">0</span></div>
                        <div class="record">
                            <div class="record-text">Số bản ghi/trang: 10</div>
                            <img src="./assets/icon/btn-prev-page.svg" alt="">
                        </div>
                        <div class="next-page">
                            <img src="./assets/icon/btn-prev-page.svg" alt="">
                            <img src="./assets/icon/btn-next-page.svg" alt="">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="form_nhanvien" style="display: none;">
        <!-- <form action="/submit_employee" method="post"> -->
        <form id="employeeForm" action="/api/user" method="post">
            <h2>Thông tin nhân viên</h2>

            <div class="form-row">
                <div class="form-group">
                    <label for="code">Mã nhân viên</label>
                    <input type="text" id="code" name="code" required>
                </div>
                <div class="form-group">
                    <label for="userName">Họ và Tên</label>
                    <input type="text" id="userName" name="username" required>
                </div>

                <div class="form-group">
                    <label for="birthday">Ngày sinh</label>
                    <input type="date" id="birthday" name="birthday" required>
                </div>

                <div class="form-group">
                    <label for="gender">Giới tính</label>
                    <div class="gender">
                        <input type="radio" id="male" name="gender" value="male" required>
                        <label for="male">Nam</label>
                        <input type="radio" id="female" name="gender" value="female">
                        <label for="female">Nữ</label>
                        <input type="radio" id="none" name="gender" value="none">
                        <label for="none">Khác</label>
                    </div>
                </div>

            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="position">Vị trí</label>
                    <input type="text" id="position" name="position" required>
                </div>
                <div class="form-group">
                    <label for="personalNumber">Số CMTND</label>
                    <input type="text" id="personalNumber" name="personalNumber" required>
                </div>
                <div class="form-group">

                    <label for="create_date">Ngày cấp</label>
                    <input type="date" id="create_date" name="create_date" placeholder="mm/dd/yyyy" required>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="department">Phòng ban</label>
                    <input type="text" id="department" name="department" required>
                </div>
                <div class="form-group">
                    <label for="issued_By">Nơi cấp</label>
                    <input type="text" id="issued_By" name="issued_By" required>
                </div>
            </div>

            <div class="form-group">
                <label for="address">Địa chỉ</label>
                <input type="text" id="address" name="address" required>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="mobilePhone">ĐT Di động</label>
                    <input type="tel" id="mobilePhone" name="mobilePhone" required>
                </div>
                <div class="form-group">
                    <label for="landline">ĐT cố định</label>
                    <input type="tel" id="landline" name="landline" required>
                </div>
                <div class="form-group">

                    <label for="email">Email</label>
                    <input type="email" id="email" name="email" required>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="bacnkCode">Tài khoản ngân hàng</label>
                    <input type="text" id="bacnkCode" name="bacnkCode" required>
                </div>
                <div class="form-group">
                    <label for="bankName">Tên ngân hàng</label>
                    <input type="text" id="bankName" name="bankName" required>
                </div>
                <div class="form-group">
                    <label for="bankBranch">Chi nhánh</label>
                    <input type="text" id="bankBranch" name="bankBranch" required>
                </div>
            </div>
            <div class="buttons">
                <button type="button" class="cancel">Huỷ</button>
                <button type="submit" class="save">Cất</button>
            </div>
        </form>
    </div>

    <script>
        // restAPI get all user
        document.addEventListener('DOMContentLoaded', function () {
            fetch('http://localhost:5179/api/v1/CustomerGroups')
                .then(response => response.json())
                .then(data => {
                    console.log(data);
                    populateTable(data);
                })
                .catch(error => console.error('Error fetching data:', error));
            fetch('http://localhost:5179/api/v1/CustomerGroups/count')
                .then(response => response.json())
                .then(count => {
                    document.getElementById('userCount').innerText = count;
                })
                .catch(error => console.error('Error fetching user count:', error));
        });

        function populateTable(users) {
            const tableBody = document.getElementById('myTable');
            tableBody.innerHTML = '';

            users.forEach((user, index) => {
                const row = document.createElement('tr');

                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${user.code}</td>
                    <td>${user.userName}</td>
                    <td>${user.gender}</td>
                    <td>${new Date(user.birthday).toLocaleDateString()}</td>
                    <td>${user.email}</td>
                    <td class="address-cell">${user.address}
                        <div class="icons">
                            <div class="edit" data-user-id="${user.id}">
                                <img src="./assets/icon/pencil-icon.png" alt="Edit" class="action-icon">
                            </div>
                            <div class="copy" data-user-id="${user.id}">
                                <img src="./assets/icon/copy-icon.png" alt="Copy" class="action-icon">
                            </div>
                            <div class="delete" data-user-id="${user.id}">
                                <img src="./assets/icon/close-48.png" alt="Delete" class="action-icon">
                            </div>
                        </div>
                    </td>
                `;
                tableBody.appendChild(row);
            });
            // fuction edit user by userID
            document.querySelectorAll('.edit').forEach(editButton => {
                editButton.addEventListener('click', function () {
                    const userId = this.getAttribute('data-user-id'); // Lấy user ID từ thuộc tính data-user-id
                    console.log("UserID: " + userId);
                    fetch(`http://localhost:5179/api/v1/CustomerGroups/${userId}`)
                        .then(response => response.json())
                        .then(user => {
                            fillForm(user);
                            const form = document.getElementById('employeeForm');
                            form.dataset.userId = userId; // Set data-user-id for the form
                            document.querySelector('.form_nhanvien').style.display = 'block';
                        })
                        .catch(error => console.error('Error fetching user:', error));
                });
            });
            document.querySelectorAll('.copy').forEach(copyButton => {
                copyButton.addEventListener('click', function () {
                    const userId = parseInt(this.getAttribute('data-user-id'));
                    const user = users.find(u => u.id === userId);
                    if (user) { // true -> copy in clipboard
                        const userInfo = `
                        ID: ${user.id}
                        Code: ${user.code}
                        Name: ${user.userName}
                        Gender: ${user.gender}
                        Birthday: ${new Date(user.birthday).toLocaleDateString()}
                        Email: ${user.email}
                        Address: ${user.address}
                    `;
                        console.log("Copy user info: " + userInfo.trim());
                        navigator.clipboard.writeText(userInfo.trim())
                            .then(() => {
                                console.log('User info copied to clipboard');
                            })
                            .catch(error => console.error('Error copying user info:', error));
                    } else {
                        console.error('User not found');
                    }
                });
            });
            // delete user by userID
            document.querySelectorAll('.delete').forEach(deleteButton => {
                deleteButton.addEventListener('click', function () {
                    const userId = this.getAttribute('data-user-id');
                    console.log("UserID id test: " + userId);
                    if (confirm('Are you sure you want to delete this user?')) {
                        fetch(`http://localhost:5179/api/v1/CustomerGroups/${userId}`, {
                            method: 'DELETE',
                        })
                            .then(response => {
                                if (response.ok) {
                                    console.log('User deleted successfully');
                                    fetchUsers();
                                } else {
                                    console.error('Error deleting user:', response.statusText);
                                }
                            })
                            .catch(error => console.error('Error:', error));
                    }
                });
            });
        }

        // show data user when edit user by userID
        function fillForm(user) {
            document.getElementById('code').value = user.code;
            document.getElementById('userName').value = user.userName;
            document.getElementById('birthday').value = user.birthday.split('T')[0];
            document.getElementById('position').value = user.position;
            document.getElementById('personalNumber').value = user.personalNumber;
            document.getElementById('create_date').value = user.create_date.split('T')[0];
            document.getElementById('department').value = user.department;
            document.getElementById('issued_By').value = user.issued_By;
            document.getElementById('address').value = user.address;
            document.getElementById('mobilePhone').value = user.mobilePhone;
            document.getElementById('landline').value = user.landline;
            document.getElementById('email').value = user.email;
            document.getElementById('bacnkCode').value = user.bacnkCode;
            document.getElementById('bankName').value = user.bankName;
            document.getElementById('bankBranch').value = user.bankBranch;

            const genderRadios = document.getElementsByName('gender');
            for (let radio of genderRadios) {
                if (radio.value === user.gender) {
                    radio.checked = true;
                }
            }
        }

        // listener click close -> on of sidebar
        document.querySelector('.close').addEventListener('click', function () {
            const sidebar = document.querySelector('.sidebar');
            const isCollapsed = sidebar.classList.toggle('collapsed');
            const manager = document.querySelector('.button-add-employee');
            const exxport = document.querySelector('.export');
            const endtable = document.querySelector('.record');

            if (isCollapsed) {
                sidebar.style.width = '70px';
                manager.style.marginLeft = '978px';
                exxport.style.marginLeft = '838px';
                endtable.style.paddingLeft = '965px';
            } else {
                sidebar.style.width = '18%';
                manager.style.marginLeft = '828px';
                exxport.style.marginLeft = '726px';
                endtable.style.paddingLeft = '814px';
            }

            const closeText = document.querySelector('.close-text');
            closeText.style.display = isCollapsed ? 'none' : 'block';

            const closeIcon = document.querySelector('.close img');
            closeIcon.style.transform = isCollapsed ? 'rotate(180deg)' : 'rotate(0deg)';
        });

        document.querySelector('.cancel').addEventListener('click', function () {
            const inputs = document.querySelectorAll('.form_nhanvien input');
            inputs.forEach(input => input.value = '');
            const radios = document.querySelectorAll('.form_nhanvien input[type="radio"]');
            radios.forEach(radio => radio.checked = false);
            document.querySelector('.form_nhanvien').style.display = 'none';
        });

        document.querySelector('.button-add-employee').addEventListener('click', function () {
            document.querySelector('.form_nhanvien').style.display = 'block';
        });

        document.getElementById('employeeForm').addEventListener('submit', function (event) {
            event.preventDefault();

            const form = event.target;
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());

            // const userId = this.getAttribute('data-user-id');
            const userId = form.dataset.userId;
            console.log("UserID cho update: " + userId);
            const method = userId ? 'PUT' : 'POST';
            const url = userId ? `http://localhost:5179/api/v1/CustomerGroups/${userId}` : 'http://localhost:5179/api/v1/CustomerGroups';


            fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data),
            })
                .then(response => response.json())
                .then(result => {
                    console.log('Success:', result);
                    // Cập nhật lại danh sách người dùng sau khi thêm/sửa
                    document.querySelector('.form_nhanvien').style.display = 'none';
                    document.querySelector('.cancel').click();
                    // Fetch lại dữ liệu để cập nhật bảng
                    fetch('http://localhost:5179/api/v1/CustomerGroups')
                        // fetchUsers();
                        .then(response => response.json())
                        .then(data => populateTable(data))
                        .catch(error => console.error('Error fetching data:', error));
                })
                .catch(error => {
                    console.error('Error:', error);
                });
        });

        function fetchUsers() {
            fetch('http://localhost:5179/api/v1/CustomerGroups')
                .then(response => response.json())
                .then(data => {
                    populateTable(data);
                })
                .catch(error => console.error('Error fetching data:', error));
        }
        function fetchUsers() {
            fetch('http://localhost:5179/api/v1/CustomerGroups/count')
                .then(response => response.json())
                .then(data => {
                    populateTable(data);
                })
                .catch(error => console.error('Error fetching data:', error));
        }
    </script>
</body>

</html>